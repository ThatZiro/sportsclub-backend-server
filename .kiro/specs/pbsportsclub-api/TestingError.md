Run npm test

> pbsportsclub-api@1.0.0 test
> jest

FAIL src/test/integration/teams.test.ts
  ‚óè Test suite failed to run

    src/test/integration/teams.test.ts:49:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    49         .set('Cookie', cookies)
                              ~~~~~~~

    src/test/integration/teams.test.ts:85:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    85         .set('Cookie', cookies)
                              ~~~~~~~

    src/test/integration/teams.test.ts:105:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    105         .set('Cookie', cookies)
                               ~~~~~~~

    src/test/integration/teams.test.ts:128:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    128         .set('Cookie', cookies)
                               ~~~~~~~

    src/test/integration/teams.test.ts:154:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    154         .set('Cookie', cookies)
                               ~~~~~~~

    src/test/integration/teams.test.ts:177:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    177         .set('Cookie', cookies)
                               ~~~~~~~

    src/test/integration/teams.test.ts:200:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    200         .set('Cookie', cookies)
                               ~~~~~~~

    src/test/integration/teams.test.ts:217:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    217         .set('Cookie', cookies)
                               ~~~~~~~

    src/test/integration/teams.test.ts:235:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    235         .set('Cookie', cookies)
                               ~~~~~~~

    src/test/integration/teams.test.ts:260:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    260         .set('Cookie', cookies)
                               ~~~~~~~

    src/test/integration/teams.test.ts:278:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    278         .set('Cookie', cookies)
                               ~~~~~~~

    src/test/integration/teams.test.ts:310:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    310         .set('Cookie', captainCookies)
                               ~~~~~~~~~~~~~~

    src/test/integration/teams.test.ts:330:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    330         .set('Cookie', memberCookies)
                               ~~~~~~~~~~~~~

    src/test/integration/teams.test.ts:336:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    336         .set('Cookie', captainCookies)
                               ~~~~~~~~~~~~~~

    src/test/integration/teams.test.ts:351:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    351         .set('Cookie', captainCookies)
                               ~~~~~~~~~~~~~~

    src/test/integration/teams.test.ts:357:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    357         .set('Cookie', captainCookies)
                               ~~~~~~~~~~~~~~

FAIL src/test/integration/authorization.test.ts
  ‚óè Test suite failed to run

    src/test/integration/authorization.test.ts:34:5 - error TS2322: Type 'string | undefined' is not assignable to type 'string[]'.
      Type 'undefined' is not assignable to type 'string[]'.

    34     organizerCookies = organizerLogin.headers['set-cookie'];
           ~~~~~~~~~~~~~~~~
    src/test/integration/authorization.test.ts:40:5 - error TS2322: Type 'string | undefined' is not assignable to type 'string[]'.
      Type 'undefined' is not assignable to type 'string[]'.

    40     captainCookies = captainLogin.headers['set-cookie'];
           ~~~~~~~~~~~~~~
    src/test/integration/authorization.test.ts:46:5 - error TS2322: Type 'string | undefined' is not assignable to type 'string[]'.
      Type 'undefined' is not assignable to type 'string[]'.

    46     playerCookies = playerLogin.headers['set-cookie'];
           ~~~~~~~~~~~~~
    src/test/integration/authorization.test.ts:205:26 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    205           .set('Cookie', otherCaptainCookies)
                                 ~~~~~~~~~~~~~~~~~~~

FAIL src/test/unit/TeamService.test.ts
  ‚óè Test suite failed to run

    src/test/unit/TeamService.test.ts:311:9 - error TS2345: Argument of type '{ id: string; email: string; passwordHash: string; name: string; role: UserRole; createdAt: Date; updatedAt: Date; }' is not assignable to parameter of type '{ approve: boolean; }'.
      Property 'approve' is missing in type '{ id: string; email: string; passwordHash: string; name: string; role: UserRole; createdAt: Date; updatedAt: Date; }' but required in type '{ approve: boolean; }'.

    311         approver
                ~~~~~~~~

      src/application/dtos/team.dto.ts:104:3
        104   approve: z.boolean().default(true),
              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        'approve' is declared here.
    src/test/unit/TeamService.test.ts:364:9 - error TS2345: Argument of type '{ id: string; email: string; passwordHash: string; name: string; role: UserRole; createdAt: Date; updatedAt: Date; }' is not assignable to parameter of type '{ approve: boolean; }'.
      Property 'approve' is missing in type '{ id: string; email: string; passwordHash: string; name: string; role: UserRole; createdAt: Date; updatedAt: Date; }' but required in type '{ approve: boolean; }'.

    364         organizer
                ~~~~~~~~~

      src/application/dtos/team.dto.ts:104:3
        104   approve: z.boolean().default(true),
              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        'approve' is declared here.
    src/test/unit/TeamService.test.ts:395:63 - error TS2345: Argument of type '{ id: string; email: string; passwordHash: string; name: string; role: UserRole; createdAt: Date; updatedAt: Date; }' is not assignable to parameter of type '{ approve: boolean; }'.
      Property 'approve' is missing in type '{ id: string; email: string; passwordHash: string; name: string; role: UserRole; createdAt: Date; updatedAt: Date; }' but required in type '{ approve: boolean; }'.

    395         teamService.approveMember(teamId, userId, approverId, regularUser)
                                                                      ~~~~~~~~~~~

      src/application/dtos/team.dto.ts:104:3
        104   approve: z.boolean().default(true),
              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        'approve' is declared here.
    src/test/unit/TeamService.test.ts:424:63 - error TS2345: Argument of type '{ id: string; email: string; passwordHash: string; name: string; role: UserRole; createdAt: Date; updatedAt: Date; }' is not assignable to parameter of type '{ approve: boolean; }'.
      Property 'approve' is missing in type '{ id: string; email: string; passwordHash: string; name: string; role: UserRole; createdAt: Date; updatedAt: Date; }' but required in type '{ approve: boolean; }'.

    424         teamService.approveMember(teamId, userId, approverId, captain)
                                                                      ~~~~~~~

      src/application/dtos/team.dto.ts:104:3
        104   approve: z.boolean().default(true),
              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        'approve' is declared here.

FAIL src/test/integration/auth.test.ts
  ‚óè Test suite failed to run

    src/test/integration/auth.test.ts:56:9 - error TS18048: 'cookies' is possibly 'undefined'.

    56         cookies.some((cookie: string) => cookie.startsWith('token='))
               ~~~~~~~
    src/test/integration/auth.test.ts:56:17 - error TS2339: Property 'some' does not exist on type 'string'.

    56         cookies.some((cookie: string) => cookie.startsWith('token='))
                       ~~~~
    src/test/integration/auth.test.ts:147:9 - error TS18048: 'cookies' is possibly 'undefined'.

    147         cookies.some((cookie: string) => cookie.startsWith('token='))
                ~~~~~~~
    src/test/integration/auth.test.ts:147:17 - error TS2339: Property 'some' does not exist on type 'string'.

    147         cookies.some((cookie: string) => cookie.startsWith('token='))
                        ~~~~
    src/test/integration/auth.test.ts:208:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    208         .set('Cookie', cookies)
                               ~~~~~~~

    src/test/integration/auth.test.ts:220:9 - error TS18048: 'logoutCookies' is possibly 'undefined'.

    220         logoutCookies.some(
                ~~~~~~~~~~~~~
    src/test/integration/auth.test.ts:220:23 - error TS2339: Property 'some' does not exist on type 'string'.

    220         logoutCookies.some(
                              ~~~~
    src/test/integration/auth.test.ts:254:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    254         .set('Cookie', signupCookies)
                               ~~~~~~~~~~~~~

    src/test/integration/auth.test.ts:262:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    262         .set('Cookie', signupCookies)
                               ~~~~~~~~~~~~~

    src/test/integration/auth.test.ts:277:51 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    277       await request(app).get('/me').set('Cookie', loginCookies).expect(200);
                                                          ~~~~~~~~~~~~

    src/test/integration/auth.test.ts:282:24 - error TS2769: No overload matches this call.
      Overload 1 of 3, '(field: "Cookie", val: string[]): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string[]'.
          Type 'undefined' is not assignable to type 'string[]'.
      Overload 2 of 3, '(field: string, val: string): Test', gave the following error.
        Argument of type 'string | undefined' is not assignable to parameter of type 'string'.
          Type 'undefined' is not assignable to type 'string'.

    282         .set('Cookie', loginCookies)
                               ~~~~~~~~~~~~

    src/test/integration/auth.test.ts:303:14 - error TS2532: Object is possibly 'undefined'.

    303       expect(responses[0].status).toBe(201);
                     ~~~~~~~~~~~~

FAIL src/test/unit/AuthService.test.ts
  ‚óè AuthService ‚Ä∫ signup ‚Ä∫ should create a new user successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
        "email": "test@example.com",
        "name": "Test User",
        "passwordHash": "hashedpassword",
    +   "role": "USER",
      },

    Number of calls: 1

      74 |         12
      75 |       );
    > 76 |       expect(mockUserRepo.create).toHaveBeenCalledWith({
         |                                   ^
      77 |         email: validSignupData.email,
      78 |         passwordHash: 'hashedpassword',
      79 |         name: validSignupData.name,

      at Object.<anonymous> (src/test/unit/AuthService.test.ts:76:35)

  ‚óè AuthService ‚Ä∫ signup ‚Ä∫ should validate email format

    expect(received).rejects.toThrow(expected)

    Expected constructor: ValidationError
    Received constructor: TypeError

    Received message: "Cannot read properties of undefined (reading 'id')"

          153 |   private generateToken(user: User): string {
          154 |     const payload: JWTPayload = {
        > 155 |       userId: user.id,
              |                    ^
          156 |       email: user.email,
          157 |       role: user.role,
          158 |     };

      at AuthService.generateToken (src/application/services/AuthService.ts:155:20)
      at AuthService.signup (src/application/services/AuthService.ts:74:24)
      at Object.<anonymous> (src/test/unit/AuthService.test.ts:112:7)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (src/test/unit/AuthService.test.ts:112:61)

  ‚óè AuthService ‚Ä∫ signup ‚Ä∫ should validate password strength

    expect(received).rejects.toThrow(expected)

    Expected constructor: ValidationError
    Received constructor: TypeError

    Received message: "Cannot read properties of undefined (reading 'id')"

          153 |   private generateToken(user: User): string {
          154 |     const payload: JWTPayload = {
        > 155 |       userId: user.id,
              |                    ^
          156 |       email: user.email,
          157 |       role: user.role,
          158 |     };

      at AuthService.generateToken (src/application/services/AuthService.ts:155:20)
      at AuthService.signup (src/application/services/AuthService.ts:74:24)
      at Object.<anonymous> (src/test/unit/AuthService.test.ts:122:7)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (src/test/unit/AuthService.test.ts:122:66)

  ‚óè AuthService ‚Ä∫ validateToken ‚Ä∫ should throw error for invalid token

    expect(received).rejects.toThrow(expected)

    Expected constructor: AuthenticationError
    Received constructor: Error

    Received message: "Invalid token"

          225 |       // Arrange
          226 |       mockJwt.verify.mockImplementation(() => {
        > 227 |         throw new Error('Invalid token');
              |               ^
          228 |       });
          229 |
          230 |       // Act & Assert

      at Object.<anonymous> (src/test/unit/AuthService.test.ts:227:15)
      at AuthService.validateToken (src/application/services/AuthService.ts:129:27)
      at Object.<anonymous> (src/test/unit/AuthService.test.ts:231:32)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (src/test/unit/AuthService.test.ts:231:72)

FAIL src/test/middleware.test.ts
  ‚óè Middleware Tests ‚Ä∫ errorHandler ‚Ä∫ should handle AppError correctly

    TypeError: Cannot read properties of undefined (reading 'x-request-id')

      101 | export const createRequestContext = (req: Request): RequestContext => {
      102 |   return {
    > 103 |     requestId: (req.headers['x-request-id'] as string) || generateRequestId(),
          |                            ^
      104 |     userId: (req as any).user?.id,
      105 |     method: req.method,
      106 |     url: req.originalUrl || req.url,

      at createRequestContext (src/config/logger.ts:103:28)
      at Logger.logError (src/config/logger.ts:206:47)
      at errorHandler (src/api/middleware/errorHandler.ts:85:13)
      at Object.<anonymous> (src/test/middleware.test.ts:259:19)

  ‚óè Middleware Tests ‚Ä∫ errorHandler ‚Ä∫ should handle generic errors

    TypeError: Cannot read properties of undefined (reading 'x-request-id')

      101 | export const createRequestContext = (req: Request): RequestContext => {
      102 |   return {
    > 103 |     requestId: (req.headers['x-request-id'] as string) || generateRequestId(),
          |                            ^
      104 |     userId: (req as any).user?.id,
      105 |     method: req.method,
      106 |     url: req.originalUrl || req.url,

      at createRequestContext (src/config/logger.ts:103:28)
      at Logger.logError (src/config/logger.ts:206:47)
      at errorHandler (src/api/middleware/errorHandler.ts:85:13)
      at Object.<anonymous> (src/test/middleware.test.ts:271:19)

  ‚óè Middleware Tests ‚Ä∫ errorHandler ‚Ä∫ should include error details in development

    TypeError: Cannot read properties of undefined (reading 'x-request-id')

      101 | export const createRequestContext = (req: Request): RequestContext => {
      102 |   return {
    > 103 |     requestId: (req.headers['x-request-id'] as string) || generateRequestId(),
          |                            ^
      104 |     userId: (req as any).user?.id,
      105 |     method: req.method,
      106 |     url: req.originalUrl || req.url,

      at createRequestContext (src/config/logger.ts:103:28)
      at Logger.logError (src/config/logger.ts:206:47)
      at errorHandler (src/api/middleware/errorHandler.ts:85:13)
      at Object.<anonymous> (src/test/middleware.test.ts:284:19)

FAIL src/test/unit/LeagueService.test.ts
  ‚óè Test suite failed to run

    src/test/unit/LeagueService.test.ts:29:21 - error TS2554: Expected 2 arguments, but got 1.

    29     leagueService = new LeagueService(mockLeagueRepo);
                           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      src/application/services/LeagueService.ts:57:5
        57     private userRepository: IUserRepository
               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        An argument for 'userRepository' was not provided.
    src/test/unit/LeagueService.test.ts:90:42 - error TS2554: Expected 2 arguments, but got 1.

    90       const result = await leagueService.createLeague(leagueData);
                                                ~~~~~~~~~~~~

      src/application/services/LeagueService.ts:79:5
        79     requestingUserId: string
               ~~~~~~~~~~~~~~~~~~~~~~~~
        An argument for 'requestingUserId' was not provided.
    src/test/unit/LeagueService.test.ts:116:34 - error TS2554: Expected 2 arguments, but got 1.

    116       await expect(leagueService.createLeague(leagueData)).rejects.toThrow(
                                         ~~~~~~~~~~~~

      src/application/services/LeagueService.ts:79:5
        79     requestingUserId: string
               ~~~~~~~~~~~~~~~~~~~~~~~~
        An argument for 'requestingUserId' was not provided.
    src/test/unit/LeagueService.test.ts:126:34 - error TS2554: Expected 2 arguments, but got 1.

    126       await expect(leagueService.createLeague(invalidData)).rejects.toThrow(
                                         ~~~~~~~~~~~~

      src/application/services/LeagueService.ts:79:5
        79     requestingUserId: string
               ~~~~~~~~~~~~~~~~~~~~~~~~
        An argument for 'requestingUserId' was not provided.
    src/test/unit/LeagueService.test.ts:163:42 - error TS2554: Expected 3 arguments, but got 2.

    163       const result = await leagueService.updateLeague(leagueId, updates);
                                                 ~~~~~~~~~~~~

      src/application/services/LeagueService.ts:111:5
        111     requestingUserId: string
                ~~~~~~~~~~~~~~~~~~~~~~~~
        An argument for 'requestingUserId' was not provided.
    src/test/unit/LeagueService.test.ts:181:23 - error TS2554: Expected 3 arguments, but got 2.

    181         leagueService.updateLeague(leagueId, updates)
                              ~~~~~~~~~~~~

      src/application/services/LeagueService.ts:111:5
        111     requestingUserId: string
                ~~~~~~~~~~~~~~~~~~~~~~~~
        An argument for 'requestingUserId' was not provided.
    src/test/unit/LeagueService.test.ts:204:27 - error TS2554: Expected 2 arguments, but got 1.

    204       await leagueService.deleteLeague(leagueId);
                                  ~~~~~~~~~~~~

      src/application/services/LeagueService.ts:160:5
        160     requestingUserId: string
                ~~~~~~~~~~~~~~~~~~~~~~~~
        An argument for 'requestingUserId' was not provided.
    src/test/unit/LeagueService.test.ts:216:34 - error TS2554: Expected 2 arguments, but got 1.

    216       await expect(leagueService.deleteLeague(leagueId)).rejects.toThrow(
                                         ~~~~~~~~~~~~

      src/application/services/LeagueService.ts:160:5
        160     requestingUserId: string
                ~~~~~~~~~~~~~~~~~~~~~~~~
        An argument for 'requestingUserId' was not provided.
    src/test/unit/LeagueService.test.ts:247:42 - error TS2554: Expected 1 arguments, but got 0.

    247       const result = await leagueService.getAllLeagues();
                                                 ~~~~~~~~~~~~~

      src/application/services/LeagueService.ts:178:23
        178   async getAllLeagues(requestingUserId: string): Promise<LeagueDTO[]> {
                                  ~~~~~~~~~~~~~~~~~~~~~~~~
        An argument for 'requestingUserId' was not provided.

FAIL src/test/errorHandling.integration.test.ts
  ‚óè Test suite failed to run

    src/test/errorHandling.integration.test.ts:172:33 - error TS2683: 'this' implicitly has type 'any' because it does not have a type annotation.

    172         return originalEnd.call(this, chunk, encoding);
                                        ~~~~

      src/test/errorHandling.integration.test.ts:171:46
        171       res.end = jest.fn().mockImplementation(function (chunk, encoding) {
                                                         ~~~~~~~~
        An outer value of 'this' is shadowed by this container.

FAIL src/test/unit/UserService.test.ts
  ‚óè UserService ‚Ä∫ getUserProfile ‚Ä∫ should return user profile successfully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 0

      Object {
        "createdAt": 2025-09-22T17:57:40.547Z,
        "email": "test@example.com",
        "id": "user-1",
        "name": "Test User",
    -   "passwordHash": "hash",
        "role": "USER",
        "updatedAt": 2025-09-22T17:57:40.547Z,
      }

      50 |       // Assert
      51 |       expect(mockUserRepo.findById).toHaveBeenCalledWith(userId);
    > 52 |       expect(result).toEqual(user);
         |                      ^
      53 |     });
      54 |
      55 |     it('should throw error if user not found', async () => {

      at Object.<anonymous> (src/test/unit/UserService.test.ts:52:22)

  ‚óè UserService ‚Ä∫ updateUserProfile ‚Ä∫ should update user profile successfully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 0

      Object {
        "createdAt": 2025-09-22T17:57:40.322Z,
        "email": "updated@example.com",
        "id": "user-1",
        "name": "Updated Name",
    -   "passwordHash": "hash",
        "role": "USER",
        "updatedAt": 2025-09-22T17:57:40.633Z,
      }

      101 |       expect(mockUserRepo.findByEmail).toHaveBeenCalledWith(updates.email);
      102 |       expect(mockUserRepo.update).toHaveBeenCalledWith(userId, updates);
    > 103 |       expect(result).toEqual(updatedUser);
          |                      ^
      104 |     });
      105 |
      106 |     it('should throw error if user not found', async () => {

      at Object.<anonymous> (src/test/unit/UserService.test.ts:103:22)

  ‚óè UserService ‚Ä∫ updateUserProfile ‚Ä∫ should allow updating to same email

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 0

      Object {
        "createdAt": 2025-09-22T17:57:40.322Z,
        "email": "test@example.com",
        "id": "user-1",
        "name": "Updated Name",
    -   "passwordHash": "hash",
        "role": "USER",
        "updatedAt": 2025-09-22T17:57:40.640Z,
      }

      153 |
      154 |       // Assert
    > 155 |       expect(result).toEqual(updatedUser);
          |                      ^
      156 |     });
      157 |
      158 |     // Note: UserService doesn't perform validation - that's handled at the API layer

      at Object.<anonymous> (src/test/unit/UserService.test.ts:155:22)

FAIL src/test/repositories.test.ts
  ‚óè Console

    console.log
      prisma:error 
      Invalid `prisma.teamMember.create()` invocation in
      /home/runner/work/sportsclub-backend-server/sportsclub-backend-server/src/infrastructure/repositories/TeamMemberRepository.ts:30:48
      
        27 
        28 const preparedData = TeamMemberDomain.prepareCreateData(data);
        29 
      ‚Üí 30 const teamMember = await prisma.teamMember.create(
      Foreign key constraint violated: `team_members_team_id_fkey (index)`

      at Object.mc (node_modules/@prisma/client/runtime/library.js:21:432)

  ‚óè Repository Integration Tests ‚Ä∫ TeamMemberRepository ‚Ä∫ should create and find team members

    PrismaClientKnownRequestError: 
    Invalid `prisma.teamMember.create()` invocation in
    /home/runner/work/sportsclub-backend-server/sportsclub-backend-server/src/infrastructure/repositories/TeamMemberRepository.ts:30:48

      27 
      28 const preparedData = TeamMemberDomain.prepareCreateData(data);
      29 
    ‚Üí 30 const teamMember = await prisma.teamMember.create(
    Foreign key constraint violated: `team_members_team_id_fkey (index)`

      28 |     const preparedData = TeamMemberDomain.prepareCreateData(data);
      29 |
    > 30 |     const teamMember = await prisma.teamMember.create({
         |                        ^
      31 |       data: {
      32 |         teamId: preparedData.teamId,
      33 |         userId: preparedData.userId,

      at $n.handleRequestError (node_modules/@prisma/client/runtime/library.js:121:7315)
      at $n.handleAndLogRequestError (node_modules/@prisma/client/runtime/library.js:121:6623)
      at $n.request (node_modules/@prisma/client/runtime/library.js:121:6307)
      at l (node_modules/@prisma/client/runtime/library.js:130:9633)
      at TeamMemberRepository.create (src/infrastructure/repositories/TeamMemberRepository.ts:30:24)
      at Object.<anonymous> (src/test/repositories.test.ts:150:29)

PASS src/test/domain-validation.test.ts
PASS src/test/repository-validation.test.ts
PASS src/test/errorHandling.simple.test.ts
  ‚óè Console

    console.log
      2025-09-22 17:57:41:5741 error: Test error message Test error message

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      2025-09-22 17:57:41:5741 warn: Test warning message Test warning message

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

PASS src/test/swagger.test.ts
PASS src/test/simple.test.ts
FAIL src/test/errorHandling.test.ts (6.579 s)
  ‚óè Error Handling and Logging ‚Ä∫ Error Handler Middleware ‚Ä∫ should handle 404 errors for non-existent routes

    expected 404 "Not Found", got 401 "Unauthorized"

       97 |       const response = await request(app)
       98 |         .get('/api/non-existent-route')
    >  99 |         .expect(404);
          |          ^
      100 |
      101 |       expect(response.body).toHaveProperty('error');
      102 |       expect(response.body).toHaveProperty('message');

      at Object.<anonymous> (src/test/errorHandling.test.ts:99:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Error Handling and Logging ‚Ä∫ Error Handler Middleware ‚Ä∫ should handle validation errors with proper status code

    expect(received).toBe(expected) // Object.is equality

    Expected: "Bad Request"
    Received: "Validation failed"

      117 |       expect(response.body).toHaveProperty('error');
      118 |       expect(response.body).toHaveProperty('message');
    > 119 |       expect(response.body.error).toBe('Bad Request');
          |                                   ^
      120 |     });
      121 |
      122 |     it('should include request ID in error responses', async () => {

      at Object.<anonymous> (src/test/errorHandling.test.ts:119:35)

  ‚óè Error Handling and Logging ‚Ä∫ Error Handler Middleware ‚Ä∫ should include request ID in error responses

    expected 404 "Not Found", got 401 "Unauthorized"

      126 |         .get('/api/non-existent-route')
      127 |         .set('X-Request-ID', requestId)
    > 128 |         .expect(404);
          |          ^
      129 |
      130 |       expect(response.body.requestId).toBe(requestId);
      131 |       expect(response.headers['x-request-id']).toBe(requestId);

      at Object.<anonymous> (src/test/errorHandling.test.ts:128:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Error Handling and Logging ‚Ä∫ Error Handler Middleware ‚Ä∫ should sanitize error messages in production mode

    expected 404 "Not Found", got 401 "Unauthorized"

      139 |         const response = await request(app)
      140 |           .get('/api/non-existent-route')
    > 141 |           .expect(404);
          |            ^
      142 |
      143 |         // In production, error messages should be sanitized
      144 |         expect(response.body.message).not.toContain('database');

      at Object.<anonymous> (src/test/errorHandling.test.ts:141:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Error Handling and Logging ‚Ä∫ Error Handler Middleware ‚Ä∫ should include debug details in development mode

    expected 404 "Not Found", got 401 "Unauthorized"

      157 |         const response = await request(app)
      158 |           .get('/api/non-existent-route')
    > 159 |           .expect(404);
          |            ^
      160 |
      161 |         // In development, should include more details
      162 |         expect(response.body).toHaveProperty('error');

      at Object.<anonymous> (src/test/errorHandling.test.ts:159:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Error Handling and Logging ‚Ä∫ Request Logging ‚Ä∫ should log incoming requests

    expected 200 "OK", got 301 "Moved Permanently"

      170 |   describe('Request Logging', () => {
      171 |     it('should log incoming requests', async () => {
    > 172 |       await request(app).get('/docs').expect(200);
          |                                       ^
      173 |
      174 |       // Verify that request logging was called
      175 |       expect(appLogger.logRequest).toHaveBeenCalled();

      at Object.<anonymous> (src/test/errorHandling.test.ts:172:39)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Error Handling and Logging ‚Ä∫ Request Logging ‚Ä∫ should log responses with status codes

    expected 200 "OK", got 301 "Moved Permanently"

      177 |
      178 |     it('should log responses with status codes', async () => {
    > 179 |       await request(app).get('/docs').expect(200);
          |                                       ^
      180 |
      181 |       // Verify that response logging was called
      182 |       expect(appLogger.logResponse).toHaveBeenCalled();

      at Object.<anonymous> (src/test/errorHandling.test.ts:179:39)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Error Handling and Logging ‚Ä∫ Request Logging ‚Ä∫ should generate request ID if not provided

    expected 200 "OK", got 301 "Moved Permanently"

      184 |
      185 |     it('should generate request ID if not provided', async () => {
    > 186 |       const response = await request(app).get('/docs').expect(200);
          |                                                        ^
      187 |
      188 |       // Should have a request ID in the response headers
      189 |       expect(response.headers['x-request-id']).toBeDefined();

      at Object.<anonymous> (src/test/errorHandling.test.ts:186:56)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Error Handling and Logging ‚Ä∫ Request Logging ‚Ä∫ should preserve provided request ID

    expected 200 "OK", got 301 "Moved Permanently"

      197 |         .get('/docs')
      198 |         .set('X-Request-ID', requestId)
    > 199 |         .expect(200);
          |          ^
      200 |
      201 |       expect(response.headers['x-request-id']).toBe(requestId);
      202 |     });

      at Object.<anonymous> (src/test/errorHandling.test.ts:199:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Error Handling and Logging ‚Ä∫ Error Logging ‚Ä∫ should log errors with context when they occur

    expected 404 "Not Found", got 401 "Unauthorized"

      205 |   describe('Error Logging', () => {
      206 |     it('should log errors with context when they occur', async () => {
    > 207 |       await request(app).get('/api/non-existent-route').expect(404);
          |                                                         ^
      208 |
      209 |       // Verify that error logging was called
      210 |       expect(appLogger.logError).toHaveBeenCalled();

      at Object.<anonymous> (src/test/errorHandling.test.ts:207:57)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Error Handling and Logging ‚Ä∫ Error Logging ‚Ä∫ should sanitize sensitive data in logs

    expected 400 "Bad Request", got 201 "Created"

      219 |           name: 'Test User',
      220 |         })
    > 221 |         .expect(400); // Will fail due to validation or other issues
          |          ^
      222 |
      223 |       // Check if logging was called (error or request logging)
      224 |       const logCalls = (appLogger.logRequest as jest.Mock).mock.calls;

      at Object.<anonymous> (src/test/errorHandling.test.ts:221:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Error Handling and Logging ‚Ä∫ Async Error Handling ‚Ä∫ should handle async errors properly

    expected 401 "Unauthorized", got 500 "Internal Server Error"

      241 |           password: 'wrongpassword',
      242 |         })
    > 243 |         .expect(401);
          |          ^
      244 |
      245 |       expect(response.body).toHaveProperty('error');
      246 |       expect(response.body.error).toBe('Unauthorized');

      at Object.<anonymous> (src/test/errorHandling.test.ts:243:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Error Handling and Logging ‚Ä∫ Database Error Handling ‚Ä∫ should handle Prisma unique constraint violations

    expected 409 "Conflict", got 500 "Internal Server Error"

      263 |         .post('/api/auth/signup')
      264 |         .send(userData)
    > 265 |         .expect(409);
          |          ^
      266 |
      267 |       expect(response.body.error).toBe('Conflict');
      268 |       expect(response.body.message).toContain('already exists');

      at Object.<anonymous> (src/test/errorHandling.test.ts:265:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

Test Suites: 11 failed, 5 passed, 16 total
Tests:       24 failed, 63 passed, 87 total
Snapshots:   0 total
Time:        12.944 s
Ran all test suites.
Error: Process completed with exit code 1.